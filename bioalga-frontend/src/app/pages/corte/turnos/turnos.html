<!-- src/app/pages/corte/turnos/turnos.html -->
<div class="container-fluid py-3">
  <!-- =================== FILTROS =================== -->
  <div class="card mb-3">
    <div class="card-header">
      <i class="bi bi-funnel me-2"></i>Filtros de búsqueda
    </div>

    <div class="card-body">
      <form [formGroup]="formFiltros" class="row g-3 align-items-end">
        <div class="col-6 col-md-3">
          <label class="form-label">Caja (ID)</label>
          <input
            type="number"
            class="form-control"
            formControlName="idCaja"
            placeholder="Ej. 1"
          />
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Usuario (ID)</label>
          <input
            type="number"
            class="form-control"
            formControlName="idUsuario"
            placeholder="Ej. 2"
          />
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Desde</label>
          <input type="date" class="form-control" formControlName="desde" />
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Hasta</label>
          <input type="date" class="form-control" formControlName="hasta" />
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label">Page</label>
          <input
            type="number"
            class="form-control"
            formControlName="page"
            min="1"
          />
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label">Page size</label>
          <input
            type="number"
            class="form-control"
            formControlName="pageSize"
            min="1"
          />
        </div>

        <div class="col-12 col-md-8 text-md-end">
          <div class="btn-group">
            <button
              type="button"
              class="btn btn-primary"
              (click)="cargarTurnos()"
            >
              <i class="bi bi-search"></i> Buscar
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="limpiarFiltros()"
            >
              <i class="bi bi-eraser"></i> Limpiar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="row">
    <!-- =================== LISTA =================== -->
    <div class="col-lg-7 mb-3">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <span><i class="bi bi-journal-text me-2"></i>Turnos</span>
          <button
            class="btn btn-sm btn-success"
            type="button"
            (click)="toggleAbrir()"
          >
            <i class="bi bi-plus-circle"></i> Abrir turno
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Caja</th>
                <th>Usuario</th>
                <th>Apertura</th>
                <th>Cierre</th>
                <th class="text-end">Saldo inicial</th>
                <th class="text-end">Saldo cierre</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let t of lista()"
                [class.table-active]="seleccionado()?.id_Turno === t.id_Turno"
                (click)="seleccionar(t)"
              >
                <td>#{{ t.id_Turno }}</td>
                <td>{{ t.id_Caja }}</td>
                <td>{{ t.id_Usuario }}</td>
                <td>{{ t.apertura | date: 'short' }}</td>
                <td>{{ t.cierre ? (t.cierre | date:'short') : '-' }}</td>
                <td class="text-end">
                  $ {{ valOr0(t.saldo_Inicial) | number:'1.2-2' }}
                </td>
                <td class="text-end">
                  $ {{ ((t.saldo_Cierre ?? 0) | number:'1.2-2') }}
                </td>
                <td>
                  <span
                    class="badge"
                    [class.bg-success]="!t.cierre"
                    [class.bg-secondary]="!!t.cierre"
                  >
                    {{ t.cierre ? 'Cerrado' : 'Abierto' }}
                  </span>
                </td>
                <td class="text-end">
                  <button
                    class="btn btn-sm btn-outline-warning"
                    type="button"
                    (click)="toggleCerrar(t); $event.stopPropagation()"
                    [disabled]="!!t.cierre"
                  >
                    <i class="bi bi-check2-square"></i> Cerrar
                  </button>
                </td>
              </tr>

              <tr *ngIf="!lista().length">
                <td colspan="9" class="text-center text-muted py-3">
                  Sin resultados
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div
          class="card-footer d-flex justify-content-between align-items-center"
        >
          <div class="text-muted small">
            Página {{ formFiltros.value.page }} — Mostrando {{ lista().length }}
            de {{ total() }}
          </div>
          <div class="btn-group">
            <button
              class="btn btn-outline-secondary btn-sm"
              (click)="formFiltros.patchValue({ page: math.max(1, (formFiltros.value.page||1)-1) }); cargarTurnos();"
              [disabled]="(formFiltros.value.page||1) <= 1"
            >
              <i class="bi bi-chevron-left"></i>
            </button>

            <button
              class="btn btn-outline-secondary btn-sm"
              (click)="formFiltros.patchValue({page: (formFiltros.value.page||1)+1}); cargarTurnos();"
              [disabled]="(lista().length) < (formFiltros.value.pageSize||20)"
            >
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- =================== PANEL DETALLE / ACCIONES =================== -->
    <div class="col-lg-5">
      <!-- Seleccionado -->
      <div class="card mb-3" *ngIf="seleccionado() as t">
        <div class="card-header">
          <i class="bi bi-info-circle me-2"></i> Turno #{{ t.id_Turno }}
        </div>
        <div class="card-body">
          <div class="mb-2">
            <span class="badge bg-secondary me-2">Caja: {{ t.id_Caja }}</span>
            <span class="badge bg-light text-dark me-2"
              >Usuario: {{ t.id_Usuario }}</span
            >
            <span
              class="badge"
              [class.bg-success]="!t.cierre"
              [class.bg-secondary]="!!t.cierre"
            >
              {{ t.cierre ? 'Cerrado' : 'Abierto' }}
            </span>
          </div>

          <div class="small text-muted mb-3">
            <div>Apertura: {{ t.apertura | date:'short' }}</div>
            <div>Cierre: {{ t.cierre ? (t.cierre | date:'short') : '-' }}</div>
          </div>

          <div class="d-flex justify-content-between">
            <span>Saldo inicial</span>
            <b>$ {{ valOr0(t.saldo_Inicial) | number:'1.2-2' }}</b>
          </div>
          <div class="d-flex justify-content-between">
            <span>Saldo cierre</span>
            <b>$ {{ ((t.saldo_Cierre ?? 0) | number:'1.2-2') }}</b>
          </div>
        </div>
        <div class="card-footer text-end">
          <button
            class="btn btn-outline-warning"
            (click)="toggleCerrar(t)"
            [disabled]="!!t.cierre"
          >
            <i class="bi bi-check2-square"></i> Cerrar turno
          </button>
        </div>
      </div>

      <!-- Abrir turno -->
      <div class="card mb-3" *ngIf="mostrandoAbrir()">
        <div class="card-header bg-success text-white">
          <i class="bi bi-plus-circle me-2"></i> Abrir turno
        </div>
        <div class="card-body">
          <form [formGroup]="formAbrir" class="row g-3">
            <div class="col-6">
              <label class="form-label">Caja (ID)</label>
              <input
                type="number"
                class="form-control"
                formControlName="id_Caja"
              />
            </div>
            <div class="col-6">
              <label class="form-label">Usuario (ID)</label>
              <input
                type="number"
                class="form-control"
                formControlName="id_Usuario"
              />
            </div>
            <div class="col-6">
              <label class="form-label">Saldo inicial</label>
              <input
                type="number"
                step="0.01"
                min="0"
                class="form-control"
                formControlName="saldo_Inicial"
              />
            </div>
            <div class="col-12">
              <label class="form-label">Observaciones</label>
              <textarea
                class="form-control"
                rows="2"
                formControlName="observaciones"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="card-footer d-flex justify-content-between">
          <button
            class="btn btn-outline-secondary"
            type="button"
            (click)="toggleAbrir()"
          >
            Cancelar
          </button>
          <button
            class="btn btn-success"
            type="button"
            [disabled]="cargandoAccion()"
            (click)="abrir()"
          >
            <i class="bi bi-check2-circle"></i> Abrir
          </button>
        </div>
      </div>

      <!-- Cerrar turno -->
      <div class="card mb-3" *ngIf="mostrandoCerrar()">
        <div class="card-header bg-warning">
          <i class="bi bi-check2-square me-2"></i> Cerrar turno
        </div>
        <div class="card-body">
          <form [formGroup]="formCerrar" class="row g-3">
            <div class="col-6">
              <label class="form-label">ID turno</label>
              <input
                type="number"
                class="form-control"
                formControlName="id_Turno"
                readonly
              />
            </div>
            <div class="col-6">
              <label class="form-label">Saldo cierre</label>
              <input
                type="number"
                step="0.01"
                min="0"
                class="form-control"
                formControlName="saldo_Cierre"
              />
            </div>
            <div class="col-12">
              <label class="form-label">Observaciones</label>
              <textarea
                class="form-control"
                rows="2"
                formControlName="observaciones"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="card-footer d-flex justify-content-between">
          <button
            class="btn btn-outline-secondary"
            type="button"
            (click)="mostrandoCerrar.set(false)"
          >
            Cancelar
          </button>
          <button
            class="btn btn-warning"
            type="button"
            [disabled]="cargandoAccion()"
            (click)="cerrar()"
          >
            <i class="bi bi-check2-square"></i> Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
