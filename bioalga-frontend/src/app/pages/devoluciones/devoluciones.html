<div class="container-fluid mt-3 devoluciones-container">

  <!-- ===================== LADO IZQUIERDO: BÚSQUEDA + RESULTADOS ===================== -->
  <div class="row">
    <div class="col-lg-5 mb-3">

      <!-- BUSCADOR -->
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Buscar productos</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="formBuscar" (ngSubmit)="forzarBusqueda()">
            <div class="input-group">
              <input type="text"
                     class="form-control"
                     placeholder="Buscar producto (nombre o SKU)"
                     formControlName="q"
                     (keydown)="onBuscadorKey($event)">
              <button class="btn btn-outline-secondary" type="submit">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </form>

          <!-- SUGERENCIAS -->
          <ul class="list-group mt-2"
              *ngIf="showSugerencias() && sugerencias().length">
            <li class="list-group-item d-flex justify-content-between align-items-center"
                *ngFor="let r of sugerencias(); let i = index"
                [class.active]="selectedIndex() === i"
                id="row-res-{{i}}"
                (click)="elegirProducto(r)">
              <div>
                <b>{{ r.nombre }}</b><br>

              </div>
              <span class="badge bg-info">
                ${{ r.precio ?? 0 | number:'1.2-2' }}
              </span>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ===================== LADO DERECHO: FORMULARIO DEVOLUCIÓN ===================== -->
    <div class="col-lg-7 mb-3">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Devolución</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="formDev">
            <div class="row mb-2">
              <div class="col-md-6">
                <label class="form-label">Usuario</label>
                <input type="text" class="form-control" formControlName="usuarioNombre" placeholder="Usuario que registra">
              </div>
              <div class="col-md-6">
                <label class="form-label">Motivo</label>
                <input type="text" class="form-control" formControlName="motivo" placeholder="Motivo de la devolución">
              </div>
            </div>
            <div class="form-check mb-3">
              <input type="checkbox" class="form-check-input" formControlName="regresaInventario" id="chkInv">
              <label class="form-check-label" for="chkInv">Regresa al inventario</label>
            </div>
          </form>

          <!-- TABLA DE LÍNEAS -->
          <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Producto</th>
                  <th style="width: 120px;">Cantidad</th>
                  <th style="width: 150px;">Precio Unitario</th>
                  <th>Importe</th>
                  <th style="width: 80px;"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let l of lineas(); let i = index">
                  <td>{{ l.nombre }}</td>
                  <td>
                    <div class="input-group input-group-sm">
                      <button class="btn btn-outline-secondary" type="button" (click)="cambiarCantidad(i,-1)">-</button>
                      <input type="number" class="form-control text-center" [value]="l.cantidad" readonly>
                      <button class="btn btn-outline-secondary" type="button" (click)="cambiarCantidad(i,+1)">+</button>
                    </div>
                  </td>
                  <td>
                    <input type="number"
                           class="form-control form-control-sm"
                           [value]="l.precioUnitario ?? 0"
                           [readonly]="!!formDev.value.ventaId"
                           (change)="editarPrecio(i, +($any($event.target).value || 0))">
                  </td>
                  <td>${{ (l.precioUnitario ?? 0) * l.cantidad | number:'1.2-2' }}</td>
                  <td>
                    <button class="btn btn-sm btn-danger" (click)="eliminarLinea(i)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="!lineas().length">
                  <td colspan="5" class="text-center text-muted">No hay productos en la devolución</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- TOTALES -->
          <div class="mt-3">
            <div class="d-flex justify-content-between">
              <span><b>Total Devuelto:</b></span>
              <span class="fs-5 text-danger">${{ total() | number:'1.2-2' }}</span>
            </div>
          </div>

          <!-- BOTÓN REGISTRAR -->
          <div class="mt-3 text-end">
            <button class="btn btn-primary"
                    (click)="registrarDevolucion()"
                    [disabled]="!lineas().length || cargando()">
              <i class="bi bi-arrow-counterclockwise"></i> Registrar devolución
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
